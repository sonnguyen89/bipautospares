!function(e,r){var o,t,l=!1,n=!1,c=!1,f=!1,a=!1,i=!1,p=!1,s=!1,u=[],d=[],h=[],b={},g=[];e.Abtf.proxy_setup=function(e){if(void 0===r)var r=!1;if((o=e.url||r)||console.error("Abtf.proxy()","no proxy url",e),l=e.js||!1,n=e.css||!1,(c=e.cdn||!1)&&g.push(c),f=e.js_include||!1,a=e.js_exclude||!1,i=e.css_include||!1,p=e.css_exclude||!1,e.preload){s=!0;for(x=0;x<e.preload.length;x++)"regex"===e.preload[x][0]?(h.push([e.preload[x][2],e.preload[x][3],e.preload[x][1]]),e.preload[x][4]&&(b[e.preload[x][0]]=e.preload[x][4],-1===g.indexOf(e.preload[x][4])&&g.push(e.preload[x][4]))):(u.push(e.preload[x][0]),d.push(e.preload[x][1]),e.preload[x][4]&&(b[e.preload[x][0]]=e.preload[x][4],-1===g.indexOf(e.preload[x][4])&&g.push(e.preload[x][4])));t=e.base||!1}if(0===g.length)g=!1;else for(var v=g.length,x=0;x<v;x++)g[x]=A(g[x])};var v={Element:"undefined"!=typeof Element&&Element,Document:"undefined"!=typeof Document&&Document},x={append:{},insert:{}};for(var y in v)v.hasOwnProperty(y)&&v[y]&&(x.append[y]=v[y].prototype.appendChild,x.insert[y]=v[y].prototype.insertBefore);var U=document.createElement("a");U.href=document.location.href;var A=function(e){var r=document.createElement("a");return r.href=e,r},m=function(e,r){return"css"===r?o.replace("{PROXY:URL}",escape(e)).replace("{PROXY:TYPE}",escape(r)):"js"===r?o.replace("{PROXY:URL}",escape(e)).replace("{PROXY:TYPE}",escape(r)):void 0},O=function(e,o){var l,n=!1;if(s){var c=u.indexOf(e);if(c>-1)var f=d[c];else if(h.length>0)for(var a,i,p=h.length,g=0;g<p;g++){i=!1;try{a=new RegExp(h[g][0],h[g][1]||"")}catch(e){i=!0}if(!i&&a.test(e)){n=!0,l=e,h[g][2]?f=h[g][2]:h[g][3]&&(e=h[g][3]);break}}if(f){if(void 0!==b[e])v=b[e];else var v=t;v+=f.substr(0,2)+"/",v+=f.substr(2,2)+"/",v+=f.substr(4,2)+"/",v+=f;var x=!1;if("js"===o){if(v+=".js",void 0!==r.cachedScriptUrl){var y=A(v).href;(v=r.cachedScriptUrl(y))!==y&&(x=v)}}else"css"===o&&(v+=".css");return x?n?console.log("Abtf.proxy()","localStorage regex capture",r.localUrl(l),"➤","cache:"+f,"➤",x):console.log("Abtf.proxy()","localStorage capture",r.localUrl(e),"➤","cache:"+f,"➤",x):n?console.log("Abtf.proxy()","regex capture",r.localUrl(l),"➤","cache:"+f):console.log("Abtf.proxy()","capture",r.localUrl(e),"➤","cache:"+f),v}}if("js"===o&&void 0!==r.cachedScriptUrl){var U=A(e).href;if((e=r.cachedScriptUrl(U))!==U)return n?console.log("Abtf.proxy()","localStorage regex capture",r.localUrl(l),"regex","➤",r.localUrl(U),"➤",e):console.log("Abtf.proxy()","localStorage capture",r.localUrl(U),"➤",e),e}return n?console.log("Abtf.proxy()","capture",r.localUrl(l),"regex","➤",e):console.log("Abtf.proxy()","capture",r.localUrl(e)),m(e,o)},j=function(e,r){var o="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===o.protocol)return!1;if(g&&!0!==r)for(var t=g.length,l=0;l<t;l++)if(-1!==o.href.indexOf(g[l].href))return!1;return o.host!==U.host},S=function(e){var o="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===o.protocol)return!0;if(f){for(var t=!1,l=f.length,n=0;n<l;n++)if(-1!==o.href.indexOf(f[n])){t=!0;break}if(!t)return console.log("Abtf.proxy()","ignore",r.localUrl(o.href),"not on include list"),!0}if(a)for(var l=a.length,n=0;n<l;n++)if(-1!==o.href.indexOf(a[n]))return console.log("Abtf.proxy()","ignore",r.localUrl(o.href),"on exclude list:",a[n]),!0;return!1},P=function(e){var r="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===r.protocol)return!1;if(g)for(var o=g.length,t=0;t<o;t++)if(-1!==r.href.indexOf(g[t].href))return!1;return r.host!==U.host},w=function(e){var o="object"==typeof e&&void 0!==e.href?e:A(e);if("blob:"===o.protocol)return!0;if(i){for(var t=!1,l=i.length,n=0;n<l;n++)if(-1!==o.href.indexOf(i[n])){t=!0;break}if(!t)return console.log("Abtf.proxy()","ignore",r.localUrl(o.href),"not on include list"),!0}if(p)for(var l=p.length,n=0;n<l;n++)if(-1!==o.href.indexOf(p[n]))return console.log("Abtf.proxy()","ignore",r.localUrl(o.href),"on exclude list:",p[n]),!0;return!1},C=function(e){if(e.nodeName)if("SCRIPT"===e.nodeName.toUpperCase()){if(!l)return!1;if("abtf"===e.getAttribute("rel"))return e.removeAttribute("rel"),!1;if(e.src){o=A(e.src);if(S(o))return!1;if(!j(o)){if(void 0!==r.cachedScriptUrl){if("blob:"===o.protocol)return!1;url=r.cachedScriptUrl(o.href),url!==o.href?(console.log("Abtf.proxy()","localStorage local capture",r.localUrl(o.href),"➤",url),e.src=url):console.log("Abtf.proxy()","localStorage local capture",r.localUrl(o.href),"➤","not cached")}return!1}return"js"}}else if("LINK"===e.nodeName.toUpperCase()&&"stylesheet"===e.rel.toLowerCase()){if(!n)return!1;if("abtf"===e.getAttribute("rel"))return e.removeAttribute("rel"),!1;if(e.href){var o=A(e.href);return!w(o)&&(!!P(o)&&"css")}}return!1},E=function(e){var r=C(e);if(!r)return!1;var o=A("css"===r?e.href:e.src).href,t=O(o,r);"css"===r?e.href=t:"js"===r&&(e.src=t)},R={appendChild:function(e,r){return E(r),x.append[e].call(this,r)},insertBefore:function(e,r,o){return E(r),x.insert[e].call(this,r,o)}};for(var y in v)v.hasOwnProperty(y)&&v[y]&&function(e){v[e].prototype.appendChild=function(r){return R.appendChild.call(this,e,r)},v[e].prototype.insertBefore=function(r,o){return R.insertBefore.call(this,e,r,o)}}(y);e.Abtf.proxifyScript=function(e){return j(e,!0)?m(e,"js"):e}}(window,window.Abtf);